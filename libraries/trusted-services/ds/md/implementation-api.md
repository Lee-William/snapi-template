### Hash Signing Service APIs

#### SignHash Endpoint
<br/>

Your Web App uses this endpoint to initiate the user signing flow.  The Web App is to redirect the user agent to this endpoint, which typically returns the NDI Login page for the user to enter his NDI Id for identification. The HSS then routes the sign request to the user's form factor (e.g. the NDI soft token on his mobile device) via the appropriate protocols. In the case of NDI soft token, the sign request is sent to the user via push notification to his mobile device, where the user enters his PIN to unlock the soft token to sign on the document’s hash. The sign response is returned to the HSS which verifies the signature with the user's certificate.  If all is well, the HSS returns the sign response to the Web App via HTTP redirect. The destination of the HTTP redirect is the redirect_uri parameter that you have configured for your Web App during Client App Registration.  

> Redirect URI 

As part of the security model, if your Web App passed to the signHash endpoint a redirect_uri that has not been configured during Client App Registration, the HSS will respond with an error. This is to protect against phishing of the HSS endpoints which let a malicious party replaces the redirect_uri with its own address to obtain the sign response.

To ensure the sign response is returned to a server in a controlled environment instead of frontend code residing in the user’s desktop/mobile browser, the redirect_uri must be a legit domain name under your control which can be whitelisted by the HSS.


> Request

````
GET {basePath}/hss/signatures/signHash
````

<table>
<thead>
<tr class="header">
<th align="left" colspan=4><strong>Required</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Parameter</strong></td>
<td><strong>In</strong></td>
<td><strong>Type</strong></td>
<td><strong>Description</strong></td>
</tr>
<tr class="even">
<td>client_id</td>
<td>Body</td>
<td>String</td>
<td>The client id assigned to your Web App during Client App Registration</td>
</tr>
<tr class="odd">
<td>client_secret</td>
<td>Body</td>
<td>String</td>
<td>The client secret that you obtained for your Web App during Client App Registration.</td>
</tr>
<tr class="even">
<td>nonce</td>
<td>Body</td>
<td>String</td>
<td>A random unique reference generated by the Web App, which will be included in the sign response returned by the HSS. The Web App is to match the value of the state returned with its copy to ensure the redirect is from the HSS. The Web App may use this to tie the sign response to a particular signing session, e.g. to mitigate replay attacks, CSRF etc. or restore the previous state of the Web App.</td>
</tr>
<tr class="odd">
<td>hash_alg</td>
<td>Body</td>
<td>String</td>
<td>Indicates the secure hash algorithm that is used to create the hash. This is defaulted to &quot;sha2&quot;, which is the minimum requirement supported by NDI. (see “Hash Algorithms” table below for supported algorithm and their represented value).</td>
</tr>
<tr class="even">
<td>hash</td>
<td>Body</td>
<td>String</td>
<td>This is the message digest produced by applying a hash function on a document. This value shall be displayed on Web App to allow user to perform visual validation for the signing session. The NDI App will display this value as part of the sign request.</td>
</tr>
<tr class="odd">
<td align="left" colspan=4><strong>Optional</strong></td>
</tr>
<tr class="even">
<td><strong>Parameter</strong></td>
<td><strong>In</strong></td>
<td><strong>Type</strong></td>
<td><strong>Description</strong></td>
</tr>
<tr class="odd">
<td>login_hint</td>
<td>Body</td>
<td>String</td>
<td>The Web App may capture the user's NDI Id using its UI instead of the NDI Login page. To suppress the NDI Login page, it may pass the NDI Id to the HSS by setting this field to the NDI Id obtained.</td>
</tr>
<tr class="even">
<td>redirect_uri</td>
<td>Body</td>
<td>String</td>
<td>The redirect URI of your Web App. When provided, URI must match the value provided during client app registration.</td>
</tr>
<tr class="odd">
<td>scope</td>
<td>Body</td>
<td>String</td>
<td>Space delimited and case-sensitive list of strings of functional scope values, indicating the scope of access requested. Each scope value references a scope profile defined for the WebApp during Client App Registration. If not provided, default to &quot;signHash&quot;</td>
</tr>
<tr class="even">
<td>response_type</td>
<td>Body</td>
<td>String</td>
<td>Indicates the sign response to be used. This is defaulted to &quot;json&quot; for the signing flow.</td>
</tr>
<tr class="odd">
<td>tx_id</td>
<td>Body</td>
<td>String</td>
<td>The Web App may provide the transaction id assigned to the current signing session. If specified, the HSS will include it in the sign response to the Web App’s redirect URI. Alternatively, the Web App can rely on “state” parameter.</td>
</tr>
<tr class="even">
<td>tx_expiry</td>
<td>Body</td>
<td>String</td>
<td>The Web App may provide the date-time given to process the request before timeout in yyyy-mm-dd<strong>T</strong>hh:mm:ss+08:00 e.g. 2018-06-21T18:36:36+08:00. HSS can rely on this value to provide the sign response before session timeout on the Web App. If this parameter is not specified, a default timeout of 600 seconds is used.</td>
</tr>
<tr class="odd">
    <td>tx_doc_name</td>
<td>Body</td>
<td>String</td>
<td>The document name displayed on Web App to allow user to perform visual validation for the signing session. If specified, the NDI App will display this value as part of the sign request.</td>
</tr>
<tr class="even">
<td>tx_vcode</td>
<td>Body</td>
<td>String</td>
<td>A random 6-digit numeric generated and displayed on Web App to allow user to perform visual validation for the signing session. If specified, the NDI App will display this value as part of the sign request.</td>
</tr>
</tbody>
</table>

> Response
```
Success, the NDI Login page is returned

HTTP/1.1 200 OK
Content-Type: text/html
Content: HTML of the NDI Login page
````

````
Success, the sign response is returned</strong></th>
HTTP/1.1 200 OK</p>
Content-Type: application/json</p>
{
    “uuid”: "63e514c0-5e67-11e8-9e55-e138197c233b",
    “usr_action”: “accept”,
    “jws”: “&lt;header&gt;.&lt;payload&gt;.&lt;signature&gt;”
}
````

<table>
<tr class="even">
<td><strong>Parameter</strong></td>
<td><strong>In</strong></td>
<td><strong>Type</strong></td>
<td><strong>Description</strong></td>
</tr>
<tr class="odd">
<td>uuid</td>
<td>Body</td>
<td>String</td>
<td>The uuid of the user who signed this transaction</td>
</tr>
<tr class="even">
<td>usr_action</td>
<td>Body</td>
<td>String</td>
<td>The user’s action to accept or reject this transaction</td>
</tr>
<tr class="odd">
<td>jws</td>
<td>Body</td>
<td>String</td>
<td>The signed token issued by HSS, in the form of a JWT containing identity info about the user and signed data with NDI-approved form factor. Your Web App will have to decode the JWT to inspect the claims and data in the signed token.</td>
</tr>
</tbody>
</table>

<table>
<thead>
<tr class="header">
<th align="left" colspan=4><strong>Interpreting JWS</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Parameter</strong></td>
<td><strong>In</strong></td>
<td><strong>Type</strong></td>
<td><strong>Description</strong></td>
</tr>
<tr class="even">
<td>iss</td>
<td>Payload</td>
<td>String</td>
<td>The HSS id that issued this token</td>
</tr>
<tr class="odd">
<td>aud</td>
<td>Payload</td>
<td>String</td>
<td>The client id of your web app</td>
</tr>
<tr class="even">
<td>txn: nonce</td>
<td>Payload</td>
<td>String</td>
<td>The value of the nonce provided by your Web App in the request</td>
</tr>
<tr class="odd">
<td>signData: signature</td>
<td>Payload</td>
<td>String</td>
<td>the signature value obtained from user’s device</td>
</tr>
<tr class="even">
<td>sign_time</td>
<td>Payload</td>
<td>String</td>
<td>The time the user accept the sign request, in Unix time (seconds)</td>
</tr>
<tr class="odd">
<td>iat</td>
<td>Payload</td>
<td>String</td>
<td>The time this token is issued, in Unix time (seconds)</td>
</tr>
<tr class="even">
<td>cert_PEM</td>
<td>Payload</td>
<td>String</td>
<td>The PEM of the user’s certificate, which can be used to verify the signature, obtain OCSP, and verify signer’s identity.</td>
</tr>
</tbody>
</table>

<table>
<thead>
<tr class="header">
<th><strong>Redirected, on error, the HSS returns the error code via HTTP redirect to the Web App's redirect URI.</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p>HTTP/1.1 302 Found</p>
<p>Location: {redirect_uri}?error={error_code}&amp;state={state_value}</p>
<p>Content-Length: 0</p>
<p>Access-Control-Allow-Origin: *</p>
<p>Access-Control-Allow-Headers:</p></td>
</tr>
</tbody>
</table>

<table>
<thead>
<tr class="header">
<th><strong>Client Error, invalid client id</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p>HTTP/1.1 400 Bad Request</p>
<p>Content-Type: application/json</p>
<p>{</p>
<p>&quot;err_msg&quot; = &quot;invalid client id&quot;</p>
<p>}</p></td>
</tr>
</tbody>
</table>

<table>
<thead>
<tr class="header">
<th><strong>Client Error, invalid endpoint URL</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>HTTP/1.1 404 Not Found</td>
</tr>
</tbody>
</table>

<table>
<thead>
<tr class="header">
<th><strong>Server Error, server-side errors encountered</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p>HTTP/1.1 400 Bad Request</p>
<p>Content-Type: application/json</p>
<p>{</p>
<p>“error”:”invalid_request”,</p>
<p>&quot;error_description&quot;:”This is not a valid sign request”</p>
<p>}</p></td>
</tr>
</tbody>
</table>