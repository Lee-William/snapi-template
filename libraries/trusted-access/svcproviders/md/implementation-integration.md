### Integration Reference
<br/>

#### Secure Protocol
<br/>

Integration between the NDI components and the organization’s components is secured by transport level protection and application level authorization.

![Secure Protocol flow](/assets/lib/trusted-access/resowners/img/secureprotocol.png)

##### Application Level Authorization

NDI ASP modules use access tokens (i.e. Bearer token) to verify access between modules, they support the OAuth 2.0 Client Credentials authorization flow to obtain access tokens from the Authorization Server.  The NDI ASP modules deployed at the federated site may be configured to work with the federated site’s OAuth 2.0 enabled Authorization Server.

##### Transport Level Protection

Integration between NDI components and the organization’s components is secured using mutual TLS (mTLS), where both peers (i.e. client and server) of the integration authenticate each other using certificates before establishing the trusted connection.

The federated site is required to generate keystores and CA-signed certificates for NDI modules deployed at the federated site.  These on-site NDI modules may be configured to work with keystores and certificates in popular formats e.g. PEM, DER and supporting the X.509 standard.  Modules running in the same computing node may refer to the same server keystore and certificate generated for the computing node.

The federated site is required to provide the CA-signed certificates and the associated cert chain used by the organization’s components and NDI on-site modules which integrates with the NDI off-site modules (e.g. OCSP, remote hosted Form Factor Authenticator services).

#### Domain Authorization Interface

Integration between the ASP and the federated site’s Authorization Server is through the Domain Authorization Interface, which is based on the OAuth 2.0 – Token Exchange draft specifications (draft-ietf-oauth-token-exchange-14). 

This integration is applicable for Mode 1 – ASP as the OIDC Provider,
where the ASP calls the federated site’s Authorization Server to
obtain an access token, after successfully authenticating the user. The Authorization Server is to implement the Domain Authorization Interface described as follows:

> Request 
````
POST {basePath}/token
````

<table>
<thead>
<tr class="header">
<th><strong>Required</strong></th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Parameter</strong></td>
<td><strong>In</strong></td>
<td><strong>Type</strong></td>
<td><strong>Description</strong></td>
</tr>
<tr class="even">
<td>grant_type</td>
<td>Body</td>
<td>String</td>
<td>Must be &quot;urn:ietf:params:oauth:grant-type:token-exchange&quot;</td>
</tr>
<tr class="odd">
<td>subject_token</td>
<td>Body</td>
<td>String</td>
<td>The ID token generated by the ASP after a successful user authentication</td>
</tr>
<tr class="even">
<td>subject_token_type</td>
<td>Body</td>
<td>String</td>
<td>Must be &quot;urn:ietf:params:oauth:token-type:id_token&quot;</td>
</tr>
<tr class="odd">
<td>scope</td>
<td>Body</td>
<td>String</td>
<td>The scope of access requested, this is a list of space-delimited, case-sensitive values, as defined in RFC6749 (section 3.3). The values are domain-specific references to resources or services of the protected domain</td>
</tr>
<tr class="even">
<td>requested_toke_type</td>
<td>Body</td>
<td>String</td>
<td>Set to &quot;urn:ietf:params:oauth:token-type:access_token&quot; to exchange for an access token.</td>
</tr>
</tbody>
</table>

> Response

<table>
<thead>
<tr class="header">
<th><strong>Success, the requested access token is returned</strong></th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p>HTTP/1.1 200 OK</p>
<p>Content-Type: application/json</p>
<p>{</p>
<p>&quot;access_token&quot; : &quot;eyJ0eXAiOiJKV1QiLCJhbGciOiJFUzI1NiIsImtpZCI6ImdhbnltZWRlIn0.eyJjbGllbnRfaWQiOiJjb2 1lb25zcHVycyIsImV4cCI6MTIzMjEzNDEyNCwiaWF0IjoyNDEyNDEyMTM3NX0.W_4ViMyL4VhbQRvfLYb2uXSaTmrDWmtd8SGH971ORR6shpWZRoMprzGPcR8VVkwKVYvl0H_8NWSaMudnsGxwFg&quot;</p>
<p>&quot;issued_token_type&quot; : &quot;urn:ietf:params:oauth:token-type:access_token&quot;</p>
<p>&quot;token_type&quot; : &quot;Bearer&quot;</p>
<p>&quot;expires_in&quot; : 600</p>
<p>}</p></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td><strong>Parameter</strong></td>
<td><strong>In</strong></td>
<td><strong>Type</strong></td>
<td><strong>Description</strong></td>
</tr>
<tr class="odd">
<td>access_token</td>
<td>Body</td>
<td>String</td>
<td>The access token generated by the Authorization Server, which can be used to access services and resources of the protected domain</td>
</tr>
<tr class="even">
<td>issued_token_type</td>
<td>Body</td>
<td>String</td>
<td>The issued token type, which is &quot;urn:ietf:params:oauth:token-type:access_token&quot;</td>
</tr>
<tr class="odd">
<td>token_type</td>
<td>Body</td>
<td>String</td>
<td>The type of access token returned, which is always &quot;Bearer&quot;</td>
</tr>
<tr class="even">
<td>expires_in</td>
<td>Body</td>
<td>String</td>
<td>The lifetime (in seconds) of the access token. For example, the value &quot;600&quot; denotes the access token will expire in 10 mins from the time the response was generated.</td>
</tr>
</tbody>
</table>

<table>
<thead>
<tr class="header">
<th><strong>Client Error, invalid request (e.g. missing parameters)</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p>HTTP/1.1 400 Bad Request</p>
<p>Content-Type: application/json</p>
<p>{</p>
<p>&quot;err_msg&quot; : {error_message}</p>
<p>}</p></td>
</tr>
</tbody>
</table>

<table>
<thead>
<tr class="header">
<th><strong>Client Error, invalid endpoint URL</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>HTTP/1.1 404 Not Found</td>
</tr>
</tbody>
</table>

<table>
<thead>
<tr class="header">
<th><strong>Server Error, server-side errors encountered</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p>HTTP/1.1 500 Internal Server Error</p>
<p>Content-Type: application/json</p>
<p>{</p>
<p>&quot;err_msg&quot; : {error_message}</p>
<p>}</p></td>
</tr>
</tbody>
</table>

#### ASP Authentication API
<br/>

This API is applicable for federated site operating the ASP in Mode 2 – ASP as an Authenticator, where the federated site’s Authorization Server calls the ASP through the ASP Authentication API for user authentication.

The ASP Authentication API is based on the OpenID Connect Implicit

Flow for Authentication Request:

> Request

````
GET {basePath}/asp/auth**
````

<table>
<thead>
<tr class="header">
<th><strong>Required</strong></th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Parameter</strong></td>
<td><strong>In</strong></td>
<td><strong>Type</strong></td>
<td><strong>Description</strong></td>
</tr>
<tr class="even">
<td>response_type</td>
<td>Body</td>
<td>String</td>
<td>Must be &quot;id_token&quot;</td>
</tr>
<tr class="odd">
<td>redirect_uri</td>
<td>Body</td>
<td>String</td>
<td>The redirection URI to which the response is sent. The response will be return directly if this endpoint is called directly by the client</td>
</tr>
<tr class="even">
<td>nonce</td>
<td>Body</td>
<td>String</td>
<td>A random generated unique reference used to associate the client session or authentication instance with the ID token to be returned, and to mitigate replay attack. The value is embedded into the ID token to be returned.</td>
</tr>
</tbody>
</table>

> **Response**

<table>
<thead>
<tr class="header">
<th><strong>Success, the requested access token is returned</strong></th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p>HTTP/1.1 200 OK</p>
<p>Content-Type: application/json</p>
<p>{</p>
<p>&quot;id_token&quot; : &quot;eyJ0eXAiOiJKV1QiLCJhbGciOiJFUzI1NiIsImtpZCI6ImdhbnltZWRlIn0.eyJjbGllbnRfaWQiOiJjb2 1lb25zcHVycyIsImV4cCI6MTIzMjEzNDEyNCwiaWF0IjoyNDEyNDEyMTM3NX0.W_4ViMyL4VhbQRvfLYb2uXSaTmrDWmtd8SGH971ORR6shpWZRoMprzGPcR8VVkwKVYvl0H_8NWSaMudnsGxwFg&quot;</p>
<p>&quot;token_type&quot; : &quot;Bearer&quot;</p>
<p>&quot;expires_in&quot; : 600</p>
<p>}</p></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td><strong>Parameter</strong></td>
<td><strong>In</strong></td>
<td><strong>Type</strong></td>
<td><strong>Description</strong></td>
</tr>
<tr class="odd">
<td>id_token</td>
<td>Body</td>
<td>String</td>
<td>The ID token generated by the ASP after a successful user authentication</td>
</tr>
<tr class="even">
<td>token_type</td>
<td>Body</td>
<td>String</td>
<td>The type of access token returned, which is always &quot;Bearer&quot;</td>
</tr>
<tr class="odd">
<td>expires_in</td>
<td>Body</td>
<td>String</td>
<td>The lifetime (in seconds) of the access token. For example, the value &quot;600&quot; denotes the access token will expire in 10 mins from the time the response was generated.</td>
</tr>
</tbody>
</table>

<table>
<thead>
<tr class="header">
<th><strong>Client Error, invalid request (e.g. missing parameters)</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p>HTTP/1.1 400 Bad Request</p>
<p>Content-Type: application/json</p>
<p>{</p>
<p>&quot;err_msg&quot; : {error_message}</p>
<p>}</p></td>
</tr>
</tbody>
</table>

<table>
<thead>
<tr class="header">
<th><strong>Client Error, invalid endpoint URL</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>HTTP/1.1 404 Not Found</td>
</tr>
</tbody>
</table>

<table>
<thead>
<tr class="header">
<th><strong>Server Error, server-side errors encountered</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p>HTTP/1.1 500 Internal Server Error</p>
<p>Content-Type: application/json</p>
<p>{</p>
<p>&quot;err_msg&quot; : {error_message}</p>
<p>}</p></td>
</tr>
</tbody>
</table>

Directory Services API
----------------------

> For organizations which choose the Deep Integration federation option,
> the organization’s authentication system integrates with the Directory
> Services to obtain form factor attributes and extension endpoint info.

### Get Form Factor Attributes

> The Directory Services consists of the NDI User Directory data store
> which holds the form factor records of NDI users. When the user logins
> using NDI, the organization’s authentication system fetches his form
> factor record from the NDI User Directory using his login id (i.e. his
> NDI Id).
>
> The form factor record has the following attributes:

<table>
<thead>
<tr class="header">
<th><strong>Attribute</strong></th>
<th><strong>Field Name</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>User UUID</td>
<td>uuid</td>
<td>A unique identifier used by NDI to reference the end-user. This is the key user reference which will be provided to the client apps (relying parties) by the ASP after successful authentication. The UUID is a perpetual id that remains constant throughout the lifespan of the end-user account.</td>
</tr>
<tr class="even">
<td>NDI Id</td>
<td>ndi_id</td>
<td>A unique id personalized by the end-user, this is the user id which the end-user enters into the NDI Login Page. The end-user can have only one personalized NDI Id, though he may change it from time to time, as long as the value is already taken by other end-users. This is stored as a hash value (SHA-256).</td>
</tr>
<tr class="odd">
<td>Certificate Serial Number</td>
<td>cert_sn</td>
<td>The serial number of the digital certificate issued to the end-user for this form factor.</td>
</tr>
<tr class="even">
<td>Status</td>
<td>status</td>
<td>The current status of this particular form factor – Active / Suspended / Revoked / Dormant</td>
</tr>
<tr class="odd">
<td>Default Indicator</td>
<td>preferred</td>
<td>This is a flag indicating this is the end-user’s preferred form factor for authentication and online transactions.</td>
</tr>
<tr class="even">
<td>Form Factor Type</td>
<td>ff_type</td>
<td>This is a value identifying the form factor type.</td>
</tr>
<tr class="odd">
<td>Form Factor Host</td>
<td>ff_host</td>
<td>A reference to the device hosting this form factor.</td>
</tr>
<tr class="even">
<td>Form Factor Id</td>
<td>ff_id</td>
<td>This is an unique identifier of the form factor, specific to the form factor type.</td>
</tr>
<tr class="odd">
<td>Used For</td>
<td>used_for</td>
<td>The permitted usage of the form factor (e.g. authentication, signing)</td>
</tr>
<tr class="even">
<td>IAL</td>
<td>ial</td>
<td>The identity assurance level (IAL) achieved for this form factor.</td>
</tr>
<tr class="odd">
<td>IA Method</td>
<td>ia_meth</td>
<td>This is a list of references of the identity assurance methods performed on this form factor.</td>
</tr>
<tr class="even">
<td>Form Factor Attributes</td>
<td>ff_attr</td>
<td>This is identity provider/form factor-specific, containing a list of attributes in a JSON (name-value) structure. For NDI soft token, this list includes attributes like device push notification registration id, token id, etc. For mobile-SIM based form factor, this list may include MSISDN, subscriber MNO, etc. The ASP uses these attributes to identify the location of the form factor in order to route the authentication request.</td>
</tr>
</tbody>
</table>

> The organization’s authentication system uses the form factor record
> for the following:

<table>
<thead>
<tr class="header">
<th>Form Factor Status (status)</th>
<th>Check the status of the form factor, reject the login if the status is not “active”</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Form Factor Type (ff_type)</td>
<td>Determine the Form Factor Authenticator endpoint to invoke, this is done by fetching the endpoint info from the Endpoint Registry using this value</td>
</tr>
<tr class="even">
<td>Form Factor Attributes (ff_attr)</td>
<td>Provide this value as part of the inputs of the authentication request when invoking the Form Factor Authenticator</td>
</tr>
<tr class="odd">
<td>Certificate Serial Number (cert_sn)</td>
<td>Check that the certificate returned in the signed response has the same serial number as this value, to ensure the certificate genuinely belongs to the user</td>
</tr>
</tbody>
</table>

> **Request**
>
> **GET {basePath}/directory/users/{ndi\_id}/formfactors**

<table>
<thead>
<tr class="header">
<th><strong>Required</strong></th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Parameter</strong></td>
<td><strong>In</strong></td>
<td><strong>Type</strong></td>
<td><strong>Description</strong></td>
</tr>
<tr class="even">
<td>ndi_id</td>
<td>Path</td>
<td>String</td>
<td>The user NDI id, given in its hash value (SHA-256, hex format)</td>
</tr>
<tr class="odd">
<td>preferred</td>
<td>Query</td>
<td>String</td>
<td>If provided, only the user’s preferred form factor record is returned</td>
</tr>
<tr class="even">
<td>cert_sn</td>
<td>Query</td>
<td>String</td>
<td>If provided, only the user’s form factor with the specified certificate serial number is returned. This is ignored if the preferred parameter is specified.</td>
</tr>
</tbody>
</table>

> **Response**

<table>
<thead>
<tr class="header">
<th><strong>Success, the requested form factor record is returned</strong></th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p>HTTP/1.1 200 OK</p>
<p>Content-Type: application/json</p>
<p>{</p>
<p>[{&quot;ndi_id&quot;:&quot;ea7226bf8f01cfea674180de5dae8123b00361a3961ffa9cb4107761f23315ad&quot;,</p>
<p>&quot;uuid&quot;:&quot;ac380d80-8fb4-11e8-bfc6-17bd42cfa150&quot;,</p>
<p>&quot;cert_sn&quot;:&quot;1532486681724 (0x164cf53047c)&quot;,</p>
<p>&quot;ff_id&quot;:&quot;ad39c610-8fb4-11e8-ac49-9998bae12994&quot;,</p>
<p>&quot;ff_type&quot;:&quot;stoken&quot;,</p>
<p>&quot;ff_host&quot;:&quot;j10&quot;,</p>
<p>&quot;status&quot;:&quot;active&quot;,</p>
<p>&quot;preferred&quot;:&quot;y&quot;,</p>
<p>&quot;use_for&quot;:&quot;authn&quot;,</p>
<p>&quot;ial&quot;:&quot;1&quot;,</p>
<p>&quot;ia_meth&quot;:&quot;[\&quot;demoia\&quot;]&quot;,</p>
<p>&quot;ff_attr&quot;:&quot;{\&quot;mp_fcm_token\&quot;:\&quot;ekdj4S7SaG4:APA91bFQ6vWaTQWl1i3_XPfLTcPSi4MijrZ6HAVw-767PHspaAaKxNOArJfkfeQB_5bahdIQZ1JIF3jm1SAfPO3A9Ck-qnlanbEc2FjPqxVMreDrT3IDcRZjmHnfRq7Hi8ZKpWkCjITUqCSPds7GLRTfVGc8BmAMSQ\&quot;}&quot;, &quot;req_by&quot;:&quot;undefined&quot;,&quot;created_t&quot;:&quot;2018-07-25T02:44:38.000Z&quot;,&quot;updated_t&quot;:&quot;2018-07-25T02:44:45.000Z&quot;}]</p>
<p>}</p></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td><strong>Parameter</strong></td>
<td><strong>In</strong></td>
<td><strong>Type</strong></td>
<td><strong>Description</strong></td>
</tr>
<tr class="odd">
<td>ndi_id</td>
<td>Body</td>
<td>String</td>
<td>The user NDI id, in its hash value (SHA-256 hex)</td>
</tr>
<tr class="even">
<td>uuid</td>
<td>Body</td>
<td>String</td>
<td>The user UUID</td>
</tr>
<tr class="odd">
<td>cert_sn</td>
<td>Body</td>
<td>String</td>
<td>The certificate serial number of the certificate issued to this form factor</td>
</tr>
<tr class="even">
<td>ff_id</td>
<td>Body</td>
<td>String</td>
<td>The form factor id</td>
</tr>
<tr class="odd">
<td>ff_type</td>
<td>Body</td>
<td>String</td>
<td>The form factor type</td>
</tr>
<tr class="even">
<td>ff_host</td>
<td>Body</td>
<td>String</td>
<td>The reference to the host device hosting the form factor</td>
</tr>
<tr class="odd">
<td>status</td>
<td>Body</td>
<td>String</td>
<td>The form factor status – “active”, “suspended”, “revoked”, or “dormant”</td>
</tr>
<tr class="even">
<td>preferred</td>
<td>Body</td>
<td>String</td>
<td>“y” – this is user’s preferred form factor</td>
</tr>
<tr class="odd">
<td>used_for</td>
<td>Body</td>
<td>String</td>
<td>The intended usage of this form factor – “authn” or “signing”</td>
</tr>
<tr class="even">
<td>ial</td>
<td>Body</td>
<td>String</td>
<td>The identity assurance level – “1”, “2” or “3”</td>
</tr>
<tr class="odd">
<td>ia_meth</td>
<td>Body</td>
<td>String</td>
<td>A space delimited string containing the identity methods performed on this form factor</td>
</tr>
<tr class="even">
<td>ff_attr</td>
<td>Body</td>
<td>String</td>
<td>A JSON object containing other attributes which are specific to the form factor type, e.g. the FCM push notification registration token.</td>
</tr>
</tbody>
</table>

<table>
<thead>
<tr class="header">
<th><strong>Client Error, invalid request (e.g. missing parameters)</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p>HTTP/1.1 400 Bad Request</p>
<p>Content-Type: application/json</p>
<p>{</p>
<p>&quot;err_msg&quot; : {error_message}</p>
<p>}</p></td>
</tr>
</tbody>
</table>

<table>
<thead>
<tr class="header">
<th><strong>Client Error, invalid endpoint URL</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>HTTP/1.1 404 Not Found</td>
</tr>
</tbody>
</table>

<table>
<thead>
<tr class="header">
<th><strong>Server Error, server-side errors encountered</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p>HTTP/1.1 500 Internal Server Error</p>
<p>Content-Type: application/json</p>
<p>{</p>
<p>&quot;err_msg&quot; : {error_message}</p>
<p>}</p></td>
</tr>
</tbody>
</table>

### Get Extension Endpoint Info

> The Directory Services consists of the Extension Registry data store
> which holds the endpoint info of extension services available to NDI.
> When the user logins using NDI, the organization’s authentication
> system fetches his form factor record from the NDI User Directory
> using his login id (i.e. his NDI Id).
>
> The form factor record has the following attributes:

<table>
<thead>
<tr class="header">
<th><strong>Attribute</strong></th>
<th><strong>Field Name</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Extension Type</td>
<td>ext_type</td>
<td>The extension type. There are a variety of extension services catering to different aspects of the NDI platform, e.g. Form Factor Authenticator for form factor authentication, Form Factor Provisioning for provisioning new form factors, etc. This attribute let the ASP select the appropriate extension service for the task it is currently performing.</td>
</tr>
<tr class="even">
<td>Extension Endpoint URI</td>
<td>endpt_uri</td>
<td>The endpoint URI to invoke the extension service. The extension is a service which implements a NDI-defined extension interface (i.e. a set of API definition) and exposes the API at the extension endpoint URI for the ASP to consume.</td>
</tr>
<tr class="odd">
<td>Form Factor Type</td>
<td>ff_type</td>
<td>The form factor type. Extension services are usually form factor specific, this attribute let the ASP select the extension service which is appropriate for the form factor it is currently dealing with.</td>
</tr>
</tbody>
</table>

> After obtaining the form factor record, the organization’s
> authentication system fetches the extension endpoint URI of the
> appropriate Form Factor Authenticator from the Extension Registry of
> the Directory Services.
>
> **Request**
>
> **GET {basePath}/directory/extensions/{type}**

<table>
<thead>
<tr class="header">
<th><strong>Required</strong></th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Parameter</strong></td>
<td><strong>In</strong></td>
<td><strong>Type</strong></td>
<td><strong>Description</strong></td>
</tr>
<tr class="even">
<td>type</td>
<td>Path</td>
<td>String</td>
<td>The extension type</td>
</tr>
<tr class="odd">
<td>Ff_type</td>
<td>Query</td>
<td>String</td>
<td>The form factor type</td>
</tr>
</tbody>
</table>

> **Response**

<table>
<thead>
<tr class="header">
<th><strong>Success, the requested access token is returned</strong></th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p>HTTP/1.1 200 OK</p>
<p>Content-Type: application/json</p>
<p>{</p>
<p>&quot;endpint_uri&quot; : &quot;https://www.sfffauth.com&quot;</p>
<p>&quot;alt_endpoint_uri&quot; : &quot;https://www.sfffauth2.com&quot;</p>
<p>}</p></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td><strong>Parameter</strong></td>
<td><strong>In</strong></td>
<td><strong>Type</strong></td>
<td><strong>Description</strong></td>
</tr>
<tr class="odd">
<td>endpoint_uri</td>
<td>Body</td>
<td>String</td>
<td>The extension endpoint URI</td>
</tr>
</tbody>
</table>

<table>
<thead>
<tr class="header">
<th><strong>Client Error, invalid request (e.g. missing parameters)</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p>HTTP/1.1 400 Bad Request</p>
<p>Content-Type: application/json</p>
<p>{</p>
<p>&quot;err_msg&quot; : {error_message}</p>
<p>}</p></td>
</tr>
</tbody>
</table>

<table>
<thead>
<tr class="header">
<th><strong>Client Error, invalid endpoint URL</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>HTTP/1.1 404 Not Found</td>
</tr>
</tbody>
</table>

<table>
<thead>
<tr class="header">
<th><strong>Server Error, server-side errors encountered</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p>HTTP/1.1 500 Internal Server Error</p>
<p>Content-Type: application/json</p>
<p>{</p>
<p>&quot;err_msg&quot; : {error_message}</p>
<p>}</p></td>
</tr>
</tbody>
</table>

Signed Response Verification
----------------------------

> The Signed Response from the end-user’s form factor is a JSON Web
> Signature (JWS) consisting of the following parameters. The following
> checks are to be performed to verify the authentication.

<table>
<thead>
<tr class="header">
<th>Parameter</th>
<th>Description</th>
<th>Checks to Perform</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>JOSE Header</td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>typ</td>
<td>“JWT”</td>
<td></td>
</tr>
<tr class="odd">
<td>alg</td>
<td>Signature algorithm – “ES256”</td>
<td>Must be “ES256” – ECC P256</td>
</tr>
<tr class="even">
<td>x5c</td>
<td>The X.509 certificate corresponding to the key used to sign the JWS, in base64-coded DER format</td>
<td>Certificate must be owned by the end-user. The certificate serial number must match the certificate serial number in the form factor attributes retrieved from the Directory Services.</td>
</tr>
<tr class="odd">
<td></td>
<td></td>
<td>Certificate must not be expired. Check the validity period field in the certificate against system time.</td>
</tr>
<tr class="even">
<td></td>
<td></td>
<td>Certificate must be valid. Verify the certificate chain using the NDI root CA and issuing CA certificates.</td>
</tr>
<tr class="odd">
<td>JWS Payload</td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>client_id</td>
<td>Echoes the client_id parameter in the signed challenge</td>
<td>Must match the client_id (cached) of the authentication request sent to the form factor.</td>
</tr>
<tr class="odd">
<td>usr_req</td>
<td>Echoes the usr_req parameter in the signed challenge</td>
<td>Must match the usr_req (cached) of the authentication request sent to the form factor.</td>
</tr>
<tr class="even">
<td>usr_resp</td>
<td>This indicates the choice made by the end-user in response to the authentication request – may be “accept”, “consent”, or “reject”</td>
<td>Must be “accept” or “consent”</td>
</tr>
<tr class="odd">
<td>token_sn</td>
<td>The unique token serial number assigned to the soft token of the end-user</td>
<td>Must match the token serial number in the form factor attributes retrieved from the Directory Services.</td>
</tr>
<tr class="even">
<td>sign_time</td>
<td>The timestamp of the signature, in POSIX time</td>
<td>Must be within the permitted time tolerance defined by the ASP or organization’s authentication system.</td>
</tr>
<tr class="odd">
<td>challenge</td>
<td>The random generated challenge string sent in the authentication request</td>
<td>Must match the challenge string (cached) of the authentication request sent to the form factor.</td>
</tr>
<tr class="even">
<td>JWS Signature</td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td>signature</td>
<td>This is the digital signature over the JOSE Header and JWS Payload, using the algorithm specified in the alg Header parameter</td>
<td>Signature created with the end-user’s private key. Must be valid. Verify the signature using the certificate specified in the <em>x5c</em> Header parameter</td>
</tr>
</tbody>
</table>