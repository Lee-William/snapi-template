# A New Way of Authentication
 
The authentication mechanism used by ASP differs from the traditional approach where the client app captures the end-user’s user credentials/secrets through a login screen and forwards the credentials/secrets to a backend user management system which verifies against a centralized password database.  
The ASP authentication mechanism utilizes a distributed approach as follows:
-	Instead of having its own login screen, the Web App (client app) invokes the authorization endpoint of the ASP, redirecting the end-user to the NDI Login Page.  The end-user enters his/her NDI id and click submit on the Login Page.  This triggers the authentication and authorization flow orchestrated by the ASP. 
-	On receiving the authentication request (consisting only the end-user’s NDI id) from the NDI Login Page, the ASP obtains the end-user’s form factor attributes from the NDI User Directory, based on his NDI id.  The form factor attributes consist of the end-user’s preferred form factor type, the form factor address (e.g. push notification id), etc.  In this case, the end-user’s preferred form factor is the NDI Soft Token.   The ASP then routes an authentication request (in the form of a signed challenge) via push notification to the NDI App residing on the end-user’s mobile device where the soft token form factor resides.
-	The end-user receives the push notification on his mobile device, inspects the description (e.g. name of the client app and scope of access requested) and accepts the authentication request.  In accepting the authentication request, the end-user may have to enter a PIN (or use fingerprint biometric) to unlock the soft token.
-	The soft token verifies the signed challenge, generates a response signed with the end-user’s private key and returns the signed response to the ASP. 
-	The ASP verifies the signature of the signed response with the end-user’s digital certificate, after checking the integrity of digital certificate by verifying the certificate chain of trust, and the status of the digital certificate with the CA’s Online Certificate Status Protocol (OCSP) service.
-	On successful user authentication, the ASP invokes the Authorization Service of the protected domain to obtain the access token for accessing resources of the protected domain.  The access token is a security token encapsulating assertions of the access granted, generated by the Authorization Service based on its access control policies and end-user consent.
-	The Web App receives an authorization code from the ASP via redirect which it uses to exchange for the ID token and access token by invoking the ASP token endpoint.
-	The Web App uses the access token to access the API/resources of the target protected domain.
Step by Step Guide
Configure Sandbox
The NDI Sandbox is a full-featured system (albeit much diminished in scale and resiliency compared to the actual system) showcasing the key use cases and flows of NDI.  It serves as a playground for developers to experiment with the API to quickly gain an understanding of how NDI works.  Follow these steps to start your exploration.  
Create Test Digital Identity
The NDI Sandbox provides the DemoKeys Enrolment application which let you enrol test users to NDI Sandbox and create digital identities for them.  Create your test users with the following steps:
1.	Open the browser to https://sandbox.ndi.io
2.	Click Create Test Digital Identity, the following screen appears:
 
3.	Click Verify Identity on the DemoKeys Enrolment screen.  The following screen appears:
  
4.	Enter your preferred user id and your email address.  Click Generate OTP for an OTP to be sent to your email address.
5.	Enter the OTP and click Verify.  On successful verification, dismiss the screen to go back to the DemoKeys Enrolment screen.
6.	At the DemoKeys Enrolment screen, enter the User Id and PIN and click Generate Digital Keys.
7.	On successful generation of keys, click Enable NDI Web Notification to allow NDI to send authentication request via Web Push to your desktop or mobile browser.
8.	Finally, click Activate to complete the user enrolment to NDI.
You may create up to 3 test users using the same email address.  Take note that the enrolment of each test user should be done on different desktops or mobile devices as the Web Push mechanism delivers authentication requests to device endpoints rather than to users.

Try Out NDI Login
You should use the Demo-WebApp application provided by the Sandbox to ensure the test users you created are working.
1.	Open browser to https://sandbox.ndi.io
2.	Click Try Out NDI Login, the Demo-WebApp screen appears, click NDI Login to launch the NDI Login screen:
 
3.	Enter the test user id and click Login.
4.	You should receive a Web Push notification informing you of an authentication request. Clicking on the notification opens the DemoKeys Form Factor screen to let you enter the PIN to unlock the digital key of the test user*.
Note:
* The Web Push used to send authentication notification to desktop/mobile browser and DemoKeys Form Factor screen is meant to emulate the actual form factor authentication flow in which the notification is sent to the user’s mobile device, where the user enters the PIN to unlock the form factor hosted on the mobile device.
Make the First Call
After ensuring your test users are working, you are all set to make your first API call.  Invoke the ASP authorization endpoint as follows:
https://sandbox.ndi.sg/api/v1/asp/auth?client_id={your_client_id}&response_type=code&
scope=openid&redirect_ur={your_redirect_uri}&
state={random_state}&nonce={random_nonce}
	Replace	{your_client_id} with your email address
{your_redirect_uri} with the URI to return the authorization code to your Web App, e.g. https://www.ganymede.com/code
{random_state} with a random alphanumeric string, e.g. 10af9431enf5
{random_nonce} with a random alphanumeric string, e.g. da5492bc0h
On successful invocation, the NDI Login screen appears.
You may now proceed to explore and try out the other ASP API at the Developer Portal and download the Demo-WebApp sample code as a reference for integrating the ASP API into your Web App. 
Register Your Web App
When you complete the integration of your Web App with NDI using the NDI Sandbox, you are ready to register your Web App at the Developer Portal to start the actual testing and deployment process.  During the Client App Registration process, you will be required to provide information about your organization, detail use case description of your Web App, and the expected TPS of authentication and other API calls.  This information will be taken as inputs to the review process to grant the use of NDI to your Web App.
Visit the Developer Portal for more information on Client App Registration. 
ASP API Reference
Authorization Endpoint
Your Web App uses this endpoint to initiate the user authentication flow.  The Web App is to redirect the user agent to this endpoint, which typically returns the NDI Login page for the user to enter his NDI Id for authentication. The ASP then routes a authentication challenge to the user's form factor (e.g. the NDI soft token on his mobile device) via the appropriate protocols. In the case of NDI soft token, the authentication challenge is sent to the user via push notification to his mobile device, where the user enters his PIN to unlock the soft token to sign on the authentication challenge. The signature response is returned to the ASP which verifies the signature with the user's certificate.  If all is well, the ASP returns a randomly generated authorization code to the Web App via HTTP redirect. The destination of the HTTP redirect is the redirect_uri parameter that you have configured for your Web App during Client App Registration.  
Redirect URI
As part of the security model, if your Web App passed to the authorization endpoint a redirect_uri that has not been configured during Client App Registration, the ASP will respond with an error. This is to protect against phishing of the ASP authorization endpoint which let a malicious party replaces the redirect_uri with its own address to obtain the authorization code.
To ensure the authorization code (and subsequently the ID token and access token) is returned to a server in a controlled environment instead of frontend code residing in the user’s desktop/mobile browser, the redirect_uri must be a legit domain name under your control which can be whitelisted by the ASP.
Authorization API
The Authorization API is as follows:
Request
GET {basePath}/asp/auth
Required
Parameter	In	Type	Description
client_id	Query	String	The client id assigned to your Web App during Client App Registration
nonce	Query	String	A random unique reference generated by the Web App, which will be included in the ID token returned by the ASP on successful user authentication. The Web App may use this to tie the ID token to a particular authenticated session, to mitigate replay attacks.
Optional
Parameter	In	Type	Description
scope	Query	String	Space delimited and case-sensitive list of strings of OAuth 2.0 scope values, indicating the scope of access requested. Each scope value references a scope profile defined for the WebApp during Client App Registration.  If not provided, default to "openid"
response_type	Query	String	Indicates the grant type flow to be used.  This is defaulted to "code" for  the Authorization Code flow, where an authorization code is used to exchange for the id token and access token.
state	Query	String	The random string generated by the client to counter Cross-Site Request Forgery (CSRF).  If specified, the ASP will include it as part of the redirect URL when returning the authorization code to the Web App's redirect URI.  The Web App is to match the value of the state returned with its copy to ensure the redirect is from the ASP.
login_hint	Query	String	The Web App may capture the user's NDI Id using its UI instead of the NDI Login page. To suppress the NDI Login page, it may pass the NDI Id to the ASP by setting login_hint to the NDI Id and setting the prompt parameter to "none".
prompt	Query	string	Set this to "none" to suppress the NDI Login page, if the login_hint parameter is set to the NDI Id, otherwise the ASP will ignore this parameter and show the NDI Login page.

Response
Success, the NDI Login page is returned
HTTP/1.1 200 OK
Content-Type: text/html
Content: HTML of the NDI Login page

Redirected, on successful user authentication, the ASP returns the authorization code via HTTP redirect to the Web App's redirect URI.  
HTTP/1.1 302 Found
Location: {redirect_uri}?code={auth_code}&state={state_value}
Content-Length: 0
Access-Control-Allow-Origin: *
Access-Control-Allow-Headers:

Redirected, on error, the ASP returns the error code via HTTP redirect to the Web App's redirect URI.
HTTP/1.1 302 Found
Location: {redirect_uri}?error={error_code}&state={state_value}
Content-Length: 0
Access-Control-Allow-Origin: *
Access-Control-Allow-Headers:

Client Error, invalid client id
HTTP/1.1 400 Bad Request
Content-Type: application/json
{
  "err_msg" = "invalid client id"
}

Client Error, invalid endpoint URL
HTTP/1.1 404 Not Found


Server Error, server-side errors encountered
HTTP/1.1 400 Internal Server Error
Content-Type: application/json
{
  "err_msg" = {error_message}
}

Token Endpoint
The token endpoint is an API where your Web App can use the authorization code obtained from the authorization endpoint to exchange for the security tokens, namely the ID token and access token.
The ID token is a JSON Web Token (JWT) containing information about the identity of the user authenticated.  
The access token is a security token which your Web App use to access API/resources of a protected domain (e.g. Government or commercial entity such as the Public Housing Agency or a bank). The access token is issued by the Authorization server of the protected domain and may be in the form of a JWT or a randomly generated reference.   Each access token comes with an expiry date, once expired, your Web App will have to re-authenticate the user to obtain a new access token, or alternatively, if the refresh token is provided, your Web App may use the refresh token to obtain a new access token without the need to re-authenticate the user.
Token API
The Token API is as follows:
Request
POST {basePath}/asp/token
Required
Parameter	In	Type	Description
code	Body	String	The authorization code obtained from the authorization endpoint.
client_id	Body	String	The client id assigned to your Web App during Client App Registration.
client_secret	Body	String	The client secret that you obtained for your Web App during Client App Registration.
redirect_uri	Body	String	The redirect URI of your Web App.
grant_type	Body	String	Set to authorization_code, as defined in OAuth 2.0 specifications

Response
Success, the ID token and access token are returned
HTTP/1.1 200 OK
Content-Type: application/json
{
    "access_token" : "95c06f5a-26d4-11e8-b467-0ed5f89f718b"
    "id_token" : "eyJ0eXAiOiJKV1QiLCJhbGciOiJFUzI1NiIsImtpZCI6ImdhbnltZWRlIn0.eyJjbGllbnRfaWQiOiJjb2 1lb25zcHVycyIsImV4cCI6MTIzMjEzNDEyNCwiaWF0IjoyNDEyNDEyMTM3NX0.W_4ViMyL4VhbQRvfLYb2uXSaTmrDWmtd8SGH971ORR6shpWZRoMprzGPcR8VVkwKVYvl0H_8NWSaMudnsGxwFg"
    "expires_in" : 600
    "token_type" : "Bearer"
}
Parameter	In	Type	Description
access_token	Body	String	The access token which can be used to access API and resources of your target protected domain.
id_token	Body	String	The ID token issued by ASP, in the form of a JWT containing identity info about the user authenticated with NDI-approved form factor.  Your Web App will have to decode the JWT to inspect the claims in the ID token.
expires_in	Body	String	The lifetime (in seconds) of the access token.  For example, the value "600" denotes the access token will expire in 10 mins from the time the response was generated. 
token_type	Body	String	The type of access token returned, which is always "Bearer".

Client Error, invalid request (e.g. missing parameters)
HTTP/1.1 400 Bad Request
Content-Type: application/json
{
  "err_msg" = {error_message}
}

Client Error, invalid endpoint URL
HTTP/1.1 404 Not Found


Server Error, server-side errors encountered
HTTP/1.1 400 Internal Server Error
Content-Type: application/json
{
  "err_msg" = {error_message}
}

Discovery Document
The OpenID Connect specifications involve the use of multiple endpoints for user authentication, and the requests for resources such as the security tokens and the public keys to verify these tokens.  To simplify the implementation and discovery of these endpoints and resources, OpenID Connect provides for the use of a Discovery document – in JSON format, and downloadable from a well-known location – which describes the OpenID Connect Provider’s configuration and supported features. 
You will be able to download the ASP Discovery document from the following location: 
GET {basePath}/asp/.well-known/openid-configuration
Your Web App should download the ASP Discovery document periodically (it is safe to download the document on a daily basis) to keep up to date of the ASP’s configuration, as the ASP endpoints may change from time to time (e.g. from /v1 to /v2), and the signing keys are also refreshed regularly.
The following shows a sample of the ASP discovery document:
{
  “issuer” : “https://zeta1.asp.ndi.io”,
  “authorization_endpoint” : “https://wog.ndi.io/v1/asp/auth”,
  “token_endpoint” : “https://wog.ndi.io/v1/asp/token”,
  “jwks_uri” : “https://wog.ndi.io/v1/certs”,
  “response_types_supported” : [
    “code”
  ],
  “subject_types_supported” : [
    “public”
  ],
  “id_token_signing_algo_values_supported” : [
    “ES256”,
    “RS256”
  ],
  “scope_supported” : [
    “opened”
  ],
  “token_endpoint_auth_methods_supported” : [
    “client_secret_post”
  ],
  “claim_supported” : [
    “aud”,
    “exp”,
    “iat”,
 “iss”,
    “sub”
  ],
  “code_challenge_methods_supported” : [
    “plain”
    “S256”
  ]
}

Security Tokens
ID Token
The ID token is issued in the form of a JWT, the following table shows the format of the ID token and the checks to perform by your Web App to ensure it is a valid ID token issued by the ASP.
Parameter	Description	Checks to Perform at the Web App
JOSE Header
typ	“JWT”	
alg	Indicates the signature algorithm used to sign this ID token.	The signature algorithm must be one of the supported asymmetric cryptography – e.g. “ES256”, “RS256”.
Must not be “NONE”.
kid	The key id indicating which ASP key was used to sign this ID token.  The ASP uses a set of signing keys whose corresponding public keys are made available in the form of the JWK (JSON Web Key) set.  The kid parameter is used to identify the right public key in the JWK set to verify the signature.	The Web App must use the public key indicated by the kid parameter to verify the signature of this ID token to ensure it is a valid ID token issued by the ASP.
The Web App is to download the ASP JWK set from the ASP discovery endpoint on a regular basis, as the ASP will periodically refresh its signing keys.  It would be considered safe to download the JWK set on a daily basis.
JWT Payload
iss	The ASP id of the ASP that issued this ID token	Ensure the ASP id points to an ASP that is recognised by your Web App.
aud	The client id of your Web App	Ensure this matches the client id of your Web App.
sub	The uuid of the user who was authenticated	Ensure this matches the value in your user record of the user.
iat	The time this ID token was issued, in Unix time (seconds)	Ensure the ID token issue timestamp is within the tolerance of your Web App, i.e. it should not be issued too long ago.
exp	The time this ID token expires, in Unix time (seconds)	Ensure the ID token has not expired.
nonce	The value of the nonce provided by your Web App in the request to the ASP authorization endpoint	Your Web App is to check that this value matches the copy in its cache, to protect against replay attacks.
JWT Signature
signature	This is the digital signature over the JOSE Header and JWS Payload, using the algorithm specified in the alg Header parameter	Signature created with the ASP’s signing key.  Must be valid.  Verify the signature using the public key indicated by the JOSE Header kid parameter.  See Checks to Perform remarks of the Header kid parameter for more details.
Access Token
The ASP does not generate access tokens, it obtains them from the Authorization Service of the protected domain.  Format of the access token varies from protected domain to protected domain.  There are 2 main approaches of implementing access tokens: 
Self-contained access token – A self-contained access token encapsulates all the authorization assertions and other assertions (e.g. issuer id, token validity period) into the token payload, with the payload signed by the Authorization Service to prevent it from tampering. The payload can also be encrypted to ensure confidentiality.  The JSON Web Token (JWT) structure is widely used to implement the self-contained access token.  The advantage of the self-contained access token is that the API Gateway can verify the integrity and the authorization assertions by simply examining the access token, without the need to check back with the Authorization Service.  
Reference-based access token -  A reference-based access token is essentially a unique randomly generated reference to an internal table containing the authorization and other assertions maintained by the Authorization Service.  The advantage of reference-based access token is that there is no need for secret keys or key-pairs to sign/encrypt access tokens, however the API Gateway will have to check back with the Authorization Service to verify the access tokens.
Refresh Token

Safe Keeping of Security Tokens
The ID token, access token and refresh token are highly confidential data, which if stolen by malicious parties will allow them to gain unauthorized access to API and resources in protected domains.  It is the responsibility of your Web App to store these tokens securely and safely dispose them after use.  These tokens must be stored in a controlled server environment and must not be sent to your frontend code residing in the user’s desktop or mobile device.  
Exception Handling
General Error Handling
Your Web App is to handle error responses from the ASP properly to provide a smooth and pleasant user experience.  For example, error messages returned by the ASP usually contains technical details which may confuse and alarm the user unnecessarily.  Your Web App should not simply display these error messages verbatim as and when these errors occur, instead your Web App should interpret these errors and take appropriate remedial action where possible, and display user-friendly messages when user attention is required.
The following are a non-exhaustive list of errors and the proper way of exception handling to implement.
Authentication Error
If you are using your own login UI to capture the NDI Id of the user, ensure your login UI allows the user to re-attempt the login up to 3 – 5 trials.  Your login UI is to be protected by anti-bot mechanism such as captcha.
Client Error (HTTP 4xx)
Client errors are mostly caused by problems at the client side (i.e. your Web App), such as badly formed requests, missing mandatory fields, invalid URL, etc.  There is no point retrying when your Web App encountered Client Errors, ensure your Web App handles user entry properly to eliminate bad request and missing fields issues.
Server Error (HTTP 500)
Server errors are mostly caused by problems at the server side (i.e. the ASP), which might be temporal in nature.  Your Web App should retry the request a couple of times and should display a “Service Unavailable” message if the same error persisted.
Timeout Error
Timeout errors may be caused by network congestion or system encountering high load, which may be intermittent in nature.  Your Web App should retry the request a couple of times but use the exponential backoff approach to avoid further contributing to the congestion.   Display the “Service Unavailable” message if the timeout error persisted.
No Response
Your Web App may receive no response when there is a network or system outage.  Your Web App should implement timeout to prevent your users from waiting indefinitely.  Display the “Service Unavailable” message if the no response situation persisted 
Error Codes
